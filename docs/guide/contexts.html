<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Icicle Lang - Contexts</title>
  <meta name="description" content>
  <meta name="author" content>

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="../css/normalize.css">
  <link rel="stylesheet" href="../css/skeleton.css">
  <link rel="stylesheet" href="../css/syntax.css">
  <link rel="stylesheet" href="../css/custom.css">

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- ATOM Feed
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="../atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

</head>
<body>
  <a href="https://github.com/icicle-lang/icicle" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  <!-- Primary Body
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
    <div class="three columns sidebar">
        <nav>
            <h3 id="logo">Icicle</h3>
            <ul>
                <li><a href="../index.html">Home</a></li>
                <li><a href="../developer-blog.html">Developer Blog</a></li>
                <li><a href="../pages/about.html">About</a></li>
                <li><a href="../pages/benchmarks.html">Benchmarks</a></li>
                <li><a href="../pages/collaboration.html">Collaboration</a></li>
            </ul>

            <h3 id="logo">Guide</h3>
            <ul>
                <li><a href="../guide/introduction.html">Introduction</a></li>
                <li><a href="../guide/syntax.html">Syntax</a></li>
                <li><a href="../guide/contexts.html">Contexts</a></li>
                <li><a href="../guide/types.html">Types</a></li>
                <li><a href="../guide/modalities.html">Modalities</a></li>
                <li><a href="../guide/records.html">Records</a></li>
            </ul>

        </nav>
        &nbsp;
    </div>

    <div class="nine columns content">
        <h1>Contexts</h1>

        <p>Icicle expressions can exist within a series of contexts which make writing features easier. One can, for example, name sub-expressions, or to pre-filter the data, but they can also do much more.</p>
<h3 id="let">Let</h3>
<p>The simplest contexts are <em>let</em> expressions, which allow one to calculate and reuse values by binding them to a name.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">let</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>  <span class="fu">total</span> <span class="op">=</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>    <span class="fu">sum</span> <span class="fu">value</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>  <span class="fu">number</span> <span class="op">=</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>    <span class="fu">count</span> <span class="fu">value</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="kw">in</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>  <span class="fu">total</span> <span class="op">/</span> <span class="fu">number</span></span></code></pre></div>
<p>You can bind many different expressions in a single <em>let</em>, by lining the names up vertically or by separating them with a semicolon.</p>
<p>When building features however, a number of other contexts are available.</p>
<h3 id="filter">Filter</h3>
<p>The <em>filter</em> context takes an expression which applies a filter to a stream before calculating an aggregate. The value calculated within the context must be aggregated, and the value which is being filtered must be a streaming element</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">proportion</span> : <span class="dt">Element</span> <span class="dt">Bool</span> <span class="op">-&gt;</span> <span class="dt">Aggregate</span> (<span class="dt">Possibly</span> <span class="dt">Double</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="fu">proportion</span> <span class="fu">check</span> <span class="op">=</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  (<span class="fu">filter</span> <span class="fu">check</span> <span class="kw">in</span> <span class="fu">count</span> <span class="fu">check</span>) <span class="op">/</span> <span class="fu">count</span> <span class="fu">check</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="co">-- Or, naming the sub-expressions with a let</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="fu">proportion</span> : <span class="dt">Element</span> <span class="dt">Bool</span> <span class="op">-&gt;</span> <span class="dt">Aggregate</span> (<span class="dt">Possibly</span> <span class="dt">Double</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="fu">proportion</span> <span class="fu">check</span> <span class="op">=</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>  <span class="kw">let</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    <span class="fu">numerator</span> <span class="op">=</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>      <span class="fu">filter</span> <span class="fu">check</span> <span class="kw">in</span> <span class="fu">count</span> <span class="fu">check</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    <span class="fu">denominator</span> <span class="op">=</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>      <span class="fu">count</span> <span class="fu">check</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>  <span class="kw">in</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>    <span class="fu">numerator</span> <span class="op">/</span> <span class="fu">denominator</span></span></code></pre></div>
<p>Returning an <em>element</em> from a filter expression is not valid, because downstream calculations wouldn’t be able to line up between different streams if a function were to be applied.</p>
<h3 id="filter-let">Filter Let</h3>
<p>The <em>filter let</em> context binds a partial pattern to filter a stream before calculating an aggregate, combining the characteristics of the preceding two contexts.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="fu">sum_options</span> : <span class="dt">Element</span> (<span class="dt">Option</span> <span class="dt">Int</span>) <span class="op">-&gt;</span> <span class="dt">Aggregate</span> <span class="dt">Int</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="fu">sum_options</span> <span class="fu">optNum</span> <span class="op">=</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  <span class="fu">filter</span> <span class="kw">let</span> <span class="dt">Some</span> <span class="fu">num</span> <span class="op">=</span> <span class="fu">optNum</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>  <span class="kw">in</span> <span class="fu">sum</span> <span class="fu">num</span></span></code></pre></div>
<p>Like <em>filter</em>, returning an <em>element</em> within the context of a <em>filter let</em> expression is a type error.</p>
<h3 id="window">Window</h3>
<p>Window is a specialised filter which only permits facts which occurred within a specific time window.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co">-- Days</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="fu">windowed</span> <span class="dv">14</span> <span class="fu">days</span> <span class="kw">in</span> <span class="fu">sum</span> <span class="fu">amount</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co">-- Weeks</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="fu">windowed</span> <span class="dv">2</span> <span class="fu">weeks</span> <span class="kw">in</span> <span class="fu">sum</span> <span class="fu">amount</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="co">-- Months</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="fu">windowed</span> <span class="dv">1</span> <span class="fu">month</span> <span class="kw">in</span> <span class="fu">sum</span> <span class="fu">amount</span></span></code></pre></div>
<p>These are extremely useful for feature engineering tasks.</p>
<h3 id="latest">Latest</h3>
<p>The <em>latest</em> contexts allows on to compute a downstream aggregation on a limited number of values which were the most recent to arrive.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="fu">latest</span> <span class="dv">10</span> <span class="kw">in</span> <span class="fu">sum</span> <span class="fu">amount</span></span></code></pre></div>
<p>Latests are implemented as circular buffers, holding only the required parts of input.</p>
<h3 id="group">Group</h3>
<p>The Group context allows one to create a map of results, with keys specified by the grouping context.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="fu">group</span> <span class="fu">key</span> <span class="kw">in</span> <span class="fu">aggregate</span> <span class="fu">elements</span></span></code></pre></div>
<p>within the context, an <em>aggregate</em> must be returned, while the key must be a streaming <em>element</em> expression. Any calculation which produces an aggregate is permitted inside a <em>group</em> expression, providing a lot of flexibility.</p>
<h3 id="fold">Fold</h3>
<p>The <em>fold</em> context is the key to aggregating data, and all functions producing <em>aggregate</em> values, such as <em>sum</em> and <em>count</em>, are implemented using this user facing language feature.</p>
<p>Folds are a programming concept similar to the <em>reduce</em> in other languages, which, given some initial state, (sometimes called the accumulator), will update its state as new data points are provided. When all the data has been seen, we can know the final state of the system.</p>
<p>Here’s how one could defined a <em>sum</em> expression, similar to how it is defined in the Icicle standard library.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="fu">sum</span> : <span class="dt">Element</span> <span class="dt">Int</span> <span class="op">-&gt;</span> <span class="dt">Aggregate</span> <span class="dt">Int</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="fu">sum</span> <span class="fu">v</span> <span class="op">=</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>  <span class="fu">fold</span> <span class="fu">acc</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>    <span class="fu">acc</span> <span class="op">+</span> <span class="fu">v</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>  <span class="kw">in</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>    <span class="fu">acc</span></span></code></pre></div>
<p>The critical keyword here is the context <code>fold</code>, which binds the name <code>acc</code> as the running state. The initial value is given after the equals sign (here, 0). Then (we use the keyword <em>then</em> here), the state is updated for every new value coming in.</p>
<p>In this example, the stream of elements is bound to the name <em>v</em>, so the new state when calculating the sum is given by <code>acc + v</code>.</p>
<p>Finally, at the end of the query, we can read the value <code>acc</code>, which is an <em>aggregate</em> value.</p>
<p>As another example, here’s how one can test if any values in a stream were true.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="co">-- Are any elements true</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="fu">any</span> : <span class="dt">Element</span> <span class="dt">Bool</span> <span class="op">-&gt;</span> <span class="dt">Aggregate</span> <span class="dt">Bool</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="fu">any</span> <span class="fu">x</span> <span class="op">=</span> <span class="fu">fold</span> <span class="fu">a</span> <span class="op">=</span> <span class="dt">False</span> <span class="cf">then</span> <span class="fu">a</span> <span class="op">||</span> <span class="fu">x</span> <span class="kw">in</span> <span class="fu">a</span></span></code></pre></div>
<p>The stream of values under test here is bound to <code>x</code>, while the accumulator is called <code>a</code>. We start the calculation with False (as no values have been true so far). Then, as each new data point comes in, we test if either <code>a</code>, or the new value <code>x</code> is true. If either of them are, then our new accumulator is going to be true as well.</p>
<p>Finally, we read the accumulator as the final answer, which will tell us if at least one of the values was true.</p>
<h3 id="scan">Scan</h3>
<p>The <em>scan</em> context is used to return the running values of an aggregating query as an element.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="fu">scan</span> <span class="fu">running_mean</span> <span class="op">=</span> <span class="fu">mean</span> <span class="fu">price</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="kw">in</span> <span class="fu">any</span> (<span class="fu">price</span> <span class="op">&gt;</span> <span class="fu">running_mean</span>)</span></code></pre></div>
<p>Scanned bindings can only be used where an aggregate value is expected.</p>
<h3 id="group-and-array-fold">Group and Array Fold</h3>
<p>Group and Array fold contexts allow for the consumption of groups (maps) and arrays as folds.</p>
<p>For example, the following expression will return the basket with the highest sum of amounts.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="fu">group</span> <span class="fu">fold</span> (<span class="fu">k</span><span class="op">,</span><span class="fu">v</span>) <span class="op">=</span> (<span class="fu">group</span> <span class="fu">basket</span> <span class="kw">in</span> <span class="fu">sum</span> <span class="fu">amount</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">in</span> <span class="fu">max_by</span> <span class="fu">v</span> <span class="fu">k</span></span></code></pre></div>
<p>One can also fold over arrays using</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="fu">array</span> <span class="fu">fold</span> <span class="fu">v</span> <span class="op">=</span> (<span class="op">...</span>) <span class="kw">in</span> <span class="op">...</span></span></code></pre></div>
<p>The syntax is like a <code>let</code> in that the patterns on the left are bound to the expression on the right, (which must be a <code>Group</code> for <code>group fold</code>), the bindings are then available within the body.</p>
<p>Usually, when using a <code>group fold</code> it will be over the results of grouping expression, and return an <code>Aggregate</code> value. It is however, also possible to use a group fold to produce an element if the input <code>Group</code> is an <code>Element</code> as well.</p>
  </div>

<!-- End Body
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>